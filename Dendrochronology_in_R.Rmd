---
title: "Dendrochronology in R"
author: "Jen Baron, j.baron@alumni.ubc.ca, UBC Tree Ring Lab"
date: 'May 8, 2020'
output:
  html_document:
    keep_md: yes
    number_sections: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

# Packages

```{r setup}
library(dplR) # dendrochronology
library(tidyr)
library(ggplot2)
```

# Load Data

```{r}
pinery.rwl <- read.rwl("data/pinery.rwl")
#master_all.rwl <- read.rwl("data/master_all.rwl")
```

```{r}
rwl.report(pinery.rwl)
```

## Basic Summary Statistics

```{r}
rwl.stats(pinery.rwl)
```

```{r}
seg.plot(pinery.rwl)
```

## Truncate Based on Date / Sample Depth

Truncate to 1898 (sample depth = 8)

```{r}
pinery.rwl.trunc <- pinery.rwl[46:166,]
```



# Crossdating


```{r}
pinery.corr <- corr.rwl.seg(pinery.rwl.trunc, seg.length = 50, 1918)
```

```{r}
#identify flags
flags <- as.data.frame(pinery.corr$flags) 
flags

#correlation by series
overall <- pinery.corr$overall
overall %>% round(2)


#average series correlation
avg.seg.rho <- as.data.frame(pinery.corr$avg.seg.rho)
avg.seg.rho %>% round(2)


#correlation by segment and series
rho <- as.data.frame(pinery.corr$spearman.rho)
rho %>% round(2)
```

There is (at least) one other way of looking at the average interseries
correlation of a data set. The interseries.cor function in dplR gives
a measure of average interseries correlation that is dierent from the rbar
measurements from rwi.stats. In this function, correlations are calculated
serially between each tree-ring series and a master chronology built from
all the other series in the rwl object (leave-one-out principle).

```{r}
interseries.cor(pinery.rwl) %>% round(2)
```



# Detrending

 Detrend all series (with ModNegExp)
```{r}
pinery.rwi <- detrend(rwl = pinery.rwl.trunc, method = "ModNegExp")
#pinery.rwi$model.info
```



## Descriptive Statistics

```{r}
pinery.ids <- read.ids(pinery.rwl.trunc)
pinery.ids
```

```{r}
rwi.stats(pinery.rwi, pinery.ids, prewhiten = TRUE)
```


# Building a Mean Value Chronology

```{r}
pinery.crn <- chron(pinery.rwi, prewhiten=FALSE)
str(pinery.crn)

pinery.crn$samp.depth <- NULL
```

## Plot Chronology

```{r}
crn.plot(pinery.crn, add.spline = TRUE, nyrs=15)
```


## Add Uncertainty Estimates

```{r}
pinery.avg <- apply(pinery.rwi,1,mean,na.rm=TRUE)

yrs <- time(pinery.crn)


se <- function(x){
  x2 <- na.omit(x)
  n <- length(x2)
  sd(x2)/sqrt(n)}


pinery.se <- apply(pinery.rwi,1,se)

pinery.sd <- apply(pinery.rwi,1,sd,na.rm=TRUE)

par(mar = c(2, 2, 2, 2), mgp = c(1.1, 0.1, 0), tcl = 0.25, xaxs='i')

plot(yrs, pinery.avg, type = "n", xlab = "Year", ylab = "RWI", axes=FALSE)
xx <- c(yrs,rev(yrs))
yy <- c(pinery.avg+pinery.se*2,rev(pinery.avg-pinery.se*2))
polygon(xx,yy,col="grey80",border = NA)
lines(yrs, pinery.avg, col = "black")
#lines(yrs, ffcsaps(pinery.avg, nyrs = 15), col = "red", lwd = 2) #adds a spline
axis(1); axis(2); axis(3); axis(4)
box()
```


# Conclude Session

```{r}
sessionInfo()
```

